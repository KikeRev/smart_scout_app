{% extends "base.html" %}
{% block content %}
<div id="chat-log" class="chat-log">
  {% if messages %}
      {% for m in messages %}
          {% include "chats/_message.html" with m=m %}
      {% endfor %}
  {% else %}
      <div class="typewriter-wrapper text-center">
      <span class="typewriter-text">Bienvenido, Â¿En quÃ© te puedo ayudar? ğŸ¤–</span>
      <span class="typewriter-cursor">|</span>
      <span class="bot-icon">ğŸ¤–</span>
    </div>
  {% endif %}
</div>

<form id="chat-form"
      hx-post="{% url 'chats:message' session.id %}"
      hx-target="#chat-log"
      hx-swap="beforeend"       
      hx-trigger="submit"
      hx-include="#chat-input"
      hx-vals='{"hx-skip-ci":true}'
      hx-indicator="#thinking-indicator"
      class="chat-form">
  {% csrf_token %}

  <textarea name="text"
          class="form-control chat-input"
          rows="4"
          style="min-height:6rem; width:100%; max-width:800px; resize:vertical;"
          placeholder="Escribe tu preguntaâ€¦" required></textarea>

  <button type="submit" class="btn btn-submit btn-send mu-3 mb-3 align-self-end">
        <span>Enviar</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor"
             viewBox="0 0 16 16"><path
             d="M15.854 0.146a.5.5 0 0 0-.527-.112l-15 6a.5.5 0 0 0 .014.94L5.5 9.418l2.444 5.158a.5.5 0 0 0 .918-.09l6-15a.5.5 0 0 0-.008-.34z"/></svg>
  </button>

  <div id="thinking-indicator" class="thinking-indicator">
        <div class="spinner"></div>
        <span>Pensandoâ€¦</span>
  </div>

</form>

<script>
  /* Limpia textarea tras enviar */
  document.addEventListener('htmx:afterRequest', (e) => {
    if (e.target.id === 'chat-form') {
      e.target.querySelector('textarea').value = '';
    }
  });

  /* EnvÃ­a el formulario con Enter (Shift+Enter = salto de lÃ­nea) */
  document.addEventListener('keydown', (e) => {
    const ta = e.target;
    const inChat = ta.tagName === 'TEXTAREA' && ta.closest('#chat-form');
    if (inChat && e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();          // evita lÃ­nea nueva
      ta.form.requestSubmit();     // dispara el submit (HTMX lo intercepta)
    }
  });
</script>
{% endblock %}


